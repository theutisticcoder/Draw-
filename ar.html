<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Museum</title>
  <style>
    body, html { margin: 0; overflow: hidden; }
    button {
      position: absolute;
      top: 10px;
      padding: 10px 16px;
      font-size: 16px;
      border: none;
      background: #007aff;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      z-index: 999;
    }
    #startButton { left: 10px; }
    #nextButton { left: 130px; display: none; }
  </style>

  <!-- Import map for Three.js -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.174.0/build/three.module.js"
      }
    }
  </script>
</head>
<body>

<button id="startButton">Start AR</button>
<button id="nextButton">Next Artwork</button>

<script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
<script src="https://libs.zappar.com/zappar-threejs/2.5.2/zappar-threejs.min.js"></script>

<script type="module">
  import * as THREE from 'three';

  const startButton = document.getElementById('startButton');
  const nextButton = document.getElementById('nextButton');

  let artworks = [];
  let currentIndex = 0;
  let lastHitPose = null;
  let camera, scene, renderer, anchorGroup, hitTestSource, refSpace;

  async function savePlacement(index, mesh) {
    const placement = {
      position: mesh.position.toArray(),
      quaternion: mesh.quaternion.toArray()
    };
    await localforage.setItem(`placement_${index}`, placement);
  }

  async function loadPlacement(index) {
    return await localforage.getItem(`placement_${index}`);
  }

  async function loadArtworks() {
    const urls = await localforage.getItem('works');
    if (!Array.isArray(urls)) {
      alert("No 'works' found in localforage!");
      return [];
    }
    return urls;
  }

  async function startAR() {
    startButton.style.display = 'none';
    nextButton.style.display = 'inline-block';

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    scene = new THREE.Scene();
    camera = new ZapparThree.Camera();
    scene.add(camera);

    const sessionManager = new ZapparThree.SessionManager();
    sessionManager.start();
    renderer.xr.setSession(await navigator.xr.requestSession("immersive-ar", {
      requiredFeatures: ["hit-test"]
    }));

    // Prepare hit test
    const xrSession = renderer.xr.getSession();
    refSpace = await xrSession.requestReferenceSpace("viewer");
    hitTestSource = await xrSession.requestHitTestSource({ space: refSpace });

    // Anchor group
    anchorGroup = new THREE.Group();
    scene.add(anchorGroup);

    const urls = await loadArtworks();
    if (!urls.length) return;

    const loader = new THREE.TextureLoader();

    for (let i = 0; i < urls.length; i++) {
      const tex = await loader.loadAsync(urls[i]);
      const mesh = new THREE.Mesh(
        new THREE.PlaneGeometry(1, 1),
        new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide })
      );
      mesh.visible = false;

      const placement = await loadPlacement(i);
      if (placement) {
        mesh.position.fromArray(placement.position);
        mesh.quaternion.fromArray(placement.quaternion);
        mesh.visible = true;
      }

      anchorGroup.add(mesh);
      artworks.push(mesh);
    }

    artworks[0].visible = true;

    window.addEventListener('click', () => {
      if (!lastHitPose || !artworks[currentIndex]) return;
      const mesh = artworks[currentIndex];
      mesh.position.copy(lastHitPose.position);
      mesh.quaternion.copy(lastHitPose.quaternion);
      mesh.visible = true;
      savePlacement(currentIndex, mesh);
    });

    nextButton.onclick = () => {
      artworks[currentIndex].visible = false;
      currentIndex = (currentIndex + 1) % artworks.length;
      artworks[currentIndex].visible = true;
    };

    renderer.setAnimationLoop((timestamp, frame) => {
      if (frame) {
        const viewerPose = frame.getViewerPose(refSpace);
        const hits = frame.getHitTestResults(hitTestSource);
        if (hits.length > 0) {
          const pose = hits[0].getPose(refSpace);
          lastHitPose = {
            position: new THREE.Vector3(
              pose.transform.position.x,
              pose.transform.position.y,
              pose.transform.position.z
            ),
            quaternion: new THREE.Quaternion(
              pose.transform.orientation.x,
              pose.transform.orientation.y,
              pose.transform.orientation.z,
              pose.transform.orientation.w
            )
          };
        }
      }

      renderer.render(scene, camera);
    });
  }

  startButton.onclick = startAR;
</script>
</body>
</html>
